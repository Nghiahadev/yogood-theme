<section class="bb-wrap" data-bundle-builder>
  <div class="bb-container">

    {% if section.settings.heading != blank %}
      <h2 class="bb-heading">{{ section.settings.heading }}</h2>
    {% endif %}

    {% if section.settings.subheading != blank %}
      <p class="bb-subheading">{{ section.settings.subheading }}</p>
    {% endif %}

    {%- comment -%}
      Determine which "bundle product" to add to cart.
      On Pages: product is blank, so we use section.settings.bundle_product
      On Product pages: product exists, we can fallback to current product
    {%- endcomment -%}
    {%- assign bundle_product = product -%}
    {%- if bundle_product == blank and section.settings.bundle_product != blank -%}
      {%- assign bundle_product = section.settings.bundle_product -%}
    {%- endif -%}

    {% assign step1 = section.settings.step1_collection %}
    {% assign step2 = section.settings.step2_collection %}
    {% assign step3 = section.settings.step3_collection %}

    {% if bundle_product == blank %}
      <div class="bb-note">
        <strong>Bundle product missing:</strong>
        This section is on a Page. Please select a “Bundle product” in the section settings.
      </div>
    {% elsif step1 == blank or step2 == blank or step3 == blank %}
      <div class="bb-note">
        <strong>Bundle Builder setup needed:</strong>
        Please choose Step 1, Step 2, and Step 3 collections in the section settings.
      </div>
    {% else %}

      {% assign bundle_variant_id = bundle_product.selected_or_first_available_variant.id %}

      <div class="bb-bundle-meta">
        <div class="bb-bundle-price">
          Bundle price: <strong>{{ bundle_product.price | money }}</strong>
        </div>
      </div>

      <div class="bb-steps">

        <!-- STEP 1 -->
        <div class="bb-step" data-step="1" data-limit="{{ section.settings.step1_limit | default: 2 }}">
          <div class="bb-step-head">
            <div>
              <h3 class="bb-step-title">
                Step 1
                <span class="bb-step-rule">Select {{ section.settings.step1_limit | default: 2 }}</span>
              </h3>
              {% if section.settings.step1_note != blank %}
                <p class="bb-step-note">{{ section.settings.step1_note }}</p>
              {% endif %}
            </div>
            <div class="bb-counter">
              <span class="bb-counter-now" data-counter-now>0</span>
              <span class="bb-counter-sep">/</span>
              <span class="bb-counter-max" data-counter-max>{{ section.settings.step1_limit | default: 2 }}</span>
            </div>
          </div>

          <div class="bb-grid">
            {% for p in step1.products %}
              <label class="bb-card">
                <input
                  class="bb-check"
                  type="checkbox"
                  name="bb_step1"
                  value="{{ p.id }}"
                  data-step-choice
                  data-step="1"
                  data-title="{{ p.title | escape }}"
                  data-handle="{{ p.handle }}"
                >
                <div class="bb-card-inner">
                  <div class="bb-img">
                    {% if p.featured_image %}
                      <img
                        src="{{ p.featured_image | image_url: width: 500 }}"
                        alt="{{ p.featured_image.alt | escape }}"
                        loading="lazy"
                      >
                    {% else %}
                      <div class="bb-img-placeholder">No image</div>
                    {% endif %}
                  </div>
                  <div class="bb-meta">
                    <div class="bb-title">{{ p.title }}</div>
                    {% if section.settings.show_price %}
                      <div class="bb-price">{{ p.price | money }}</div>
                    {% endif %}
                  </div>
                </div>
              </label>
            {% endfor %}
          </div>
          <div class="bb-error" data-error></div>
        </div>

        <!-- STEP 2 -->
        <div class="bb-step" data-step="2" data-limit="{{ section.settings.step2_limit | default: 2 }}">
          <div class="bb-step-head">
            <div>
              <h3 class="bb-step-title">
                Step 2
                <span class="bb-step-rule">Select {{ section.settings.step2_limit | default: 2 }}</span>
              </h3>
              {% if section.settings.step2_note != blank %}
                <p class="bb-step-note">{{ section.settings.step2_note }}</p>
              {% endif %}
            </div>
            <div class="bb-counter">
              <span class="bb-counter-now" data-counter-now>0</span>
              <span class="bb-counter-sep">/</span>
              <span class="bb-counter-max" data-counter-max>{{ section.settings.step2_limit | default: 2 }}</span>
            </div>
          </div>

          <div class="bb-grid">
            {% for p in step2.products %}
              <label class="bb-card">
                <input
                  class="bb-check"
                  type="checkbox"
                  name="bb_step2"
                  value="{{ p.id }}"
                  data-step-choice
                  data-step="2"
                  data-title="{{ p.title | escape }}"
                  data-handle="{{ p.handle }}"
                >
                <div class="bb-card-inner">
                  <div class="bb-img">
                    {% if p.featured_image %}
                      <img
                        src="{{ p.featured_image | image_url: width: 500 }}"
                        alt="{{ p.featured_image.alt | escape }}"
                        loading="lazy"
                      >
                    {% else %}
                      <div class="bb-img-placeholder">No image</div>
                    {% endif %}
                  </div>
                  <div class="bb-meta">
                    <div class="bb-title">{{ p.title }}</div>
                    {% if section.settings.show_price %}
                      <div class="bb-price">{{ p.price | money }}</div>
                    {% endif %}
                  </div>
                </div>
              </label>
            {% endfor %}
          </div>
          <div class="bb-error" data-error></div>
        </div>

        <!-- STEP 3 -->
        <div class="bb-step" data-step="3" data-limit="{{ section.settings.step3_limit | default: 1 }}">
          <div class="bb-step-head">
            <div>
              <h3 class="bb-step-title">
                Step 3
                <span class="bb-step-rule">Select {{ section.settings.step3_limit | default: 1 }}</span>
              </h3>
              {% if section.settings.step3_note != blank %}
                <p class="bb-step-note">{{ section.settings.step3_note }}</p>
              {% endif %}
            </div>
            <div class="bb-counter">
              <span class="bb-counter-now" data-counter-now>0</span>
              <span class="bb-counter-sep">/</span>
              <span class="bb-counter-max" data-counter-max>{{ section.settings.step3_limit | default: 1 }}</span>
            </div>
          </div>

          <div class="bb-grid">
            {% for p in step3.products %}
              <label class="bb-card">
                <input
                  class="bb-check"
                  type="checkbox"
                  name="bb_step3"
                  value="{{ p.id }}"
                  data-step-choice
                  data-step="3"
                  data-title="{{ p.title | escape }}"
                  data-handle="{{ p.handle }}"
                >
                <div class="bb-card-inner">
                  <div class="bb-img">
                    {% if p.featured_image %}
                      <img
                        src="{{ p.featured_image | image_url: width: 500 }}"
                        alt="{{ p.featured_image.alt | escape }}"
                        loading="lazy"
                      >
                    {% else %}
                      <div class="bb-img-placeholder">No image</div>
                    {% endif %}
                  </div>
                  <div class="bb-meta">
                    <div class="bb-title">{{ p.title }}</div>
                    {% if section.settings.show_price %}
                      <div class="bb-price">{{ p.price | money }}</div>
                    {% endif %}
                  </div>
                </div>
              </label>
            {% endfor %}
          </div>
          <div class="bb-error" data-error></div>
        </div>

      </div>

      <!-- SUMMARY + ADD TO CART -->
      <div class="bb-footer">
        <div class="bb-summary" data-summary>
          <div class="bb-summary-title">Your selections</div>
          <div class="bb-summary-grid">
            <div class="bb-summary-col">
              <div class="bb-summary-label">Step 1</div>
              <ul class="bb-summary-list" data-summary-step="1"></ul>
            </div>
            <div class="bb-summary-col">
              <div class="bb-summary-label">Step 2</div>
              <ul class="bb-summary-list" data-summary-step="2"></ul>
            </div>
            <div class="bb-summary-col">
              <div class="bb-summary-label">Step 3</div>
              <ul class="bb-summary-list" data-summary-step="3"></ul>
            </div>
          </div>
          <div class="bb-summary-hint" data-hint></div>
        </div>

        <button class="bb-btn" type="button" data-add-to-cart disabled>
          {% if section.settings.cta_text != blank %}
            {{ section.settings.cta_text }} — {{ bundle_product.price | money }}
          {% else %}
            Add Bundle to Cart — {{ bundle_product.price | money }}
          {% endif %}
        </button>

        <div class="bb-status" data-status aria-live="polite"></div>

        <form method="post" action="/cart/add" id="bbForm" class="bb-hidden-form">
          <input type="hidden" name="id" value="{{ bundle_variant_id }}">
          <input type="hidden" name="quantity" value="1">
          <div data-properties></div>
        </form>
      </div>

    {% endif %}
  </div>

  <style>
    .bb-wrap { padding: 28px 0; }
    .bb-container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
    .bb-heading { font-size: 28px; line-height: 1.2; margin: 0 0 8px; }
    .bb-subheading { margin: 0 0 18px; opacity: .85; }
    .bb-note { background: #fff3cd; border: 1px solid #ffe69c; padding: 12px 14px; border-radius: 10px; }

    .bb-bundle-meta { margin: 6px 0 18px; }
    .bb-bundle-price { font-size: 16px; opacity: .92; }

    .bb-steps { display: flex; flex-direction: column; gap: 26px; }
    .bb-step { border: 1px solid rgba(0,0,0,.12); border-radius: 14px; padding: 16px; background: #fff; }
    .bb-step-head { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 12px; }
    .bb-step-title { margin: 0; font-size: 18px; }
    .bb-step-rule { font-size: 13px; opacity: .75; margin-left: 8px; }
    .bb-step-note { margin: 6px 0 0; font-size: 14px; opacity: .8; }

    .bb-counter { font-size: 14px; padding: 6px 10px; border-radius: 999px; background: rgba(0,0,0,.06); min-width: 64px; text-align: center; }

    .bb-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    @media (min-width: 700px) { .bb-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (min-width: 1024px) { .bb-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }

    .bb-card { display: block; cursor: pointer; }
    .bb-check { position: absolute; opacity: 0; pointer-events: none; }

    .bb-card-inner {
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      height: 100%;
    }
    .bb-card:hover .bb-card-inner { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(0,0,0,.08); }

    .bb-img { aspect-ratio: 1/1; background: rgba(0,0,0,.04); display: flex; align-items: center; justify-content: center; }
    .bb-img img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .bb-img-placeholder { font-size: 12px; opacity: .7; }

    .bb-meta { padding: 10px 12px; display: flex; justify-content: space-between; align-items: baseline; gap: 10px; }
    .bb-title { font-size: 14px; line-height: 1.3; }
    .bb-price { font-size: 13px; opacity: .75; white-space: nowrap; }

    .bb-card.is-selected .bb-card-inner { border-color: rgba(0,0,0,.6); box-shadow: 0 8px 20px rgba(0,0,0,.10); }
    .bb-card.is-selected .bb-meta { font-weight: 600; }

    .bb-error { margin-top: 10px; color: #b42318; font-size: 13px; min-height: 18px; }

    .bb-footer { margin-top: 22px; border: 1px solid rgba(0,0,0,.12); border-radius: 14px; padding: 16px; background: #fff; }
    .bb-summary-title { font-weight: 700; margin-bottom: 10px; }
    .bb-summary-grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .bb-summary-grid { grid-template-columns: repeat(3, 1fr); } }
    .bb-summary-label { font-weight: 600; font-size: 14px; margin-bottom: 6px; }
    .bb-summary-list { margin: 0; padding-left: 18px; font-size: 14px; opacity: .9; min-height: 24px; }
    .bb-summary-hint { margin-top: 10px; font-size: 13px; opacity: .75; }

    .bb-btn { margin-top: 14px; width: 100%; padding: 14px 16px; border-radius: 12px; border: 0; cursor: pointer; font-weight: 700; }
    .bb-btn:disabled { opacity: .45; cursor: not-allowed; }
    .bb-status { margin-top: 10px; font-size: 14px; min-height: 18px; }

    .bb-hidden-form { display: none; }
  </style>

  <script>
    (function() {
      const root = document.querySelector('[data-bundle-builder]');
      if (!root) return;

      const steps = Array.from(root.querySelectorAll('.bb-step'));
      const addBtn = root.querySelector('[data-add-to-cart]');
      const statusEl = root.querySelector('[data-status]');
      const hintEl = root.querySelector('[data-hint]');
      const form = root.querySelector('#bbForm');
      const propsHolder = root.querySelector('[data-properties]');

      if (!form) return;

      function getLimit(stepNum) {
        const stepEl = root.querySelector('.bb-step[data-step="' + stepNum + '"]');
        return Number(stepEl ? stepEl.dataset.limit : 0);
      }

      function getSelected(stepNum) {
        return Array.from(root.querySelectorAll('input[data-step-choice][data-step="' + stepNum + '"]:checked'));
      }

      function setCounter(stepEl) {
        const stepNum = Number(stepEl.dataset.step);
        const selected = getSelected(stepNum).length;
        const now = stepEl.querySelector('[data-counter-now]');
        const max = stepEl.querySelector('[data-counter-max]');
        if (now) now.textContent = selected;
        if (max) max.textContent = getLimit(stepNum);
      }

      function renderSummary() {
        [1,2,3].forEach((n) => {
          const list = root.querySelector('[data-summary-step="' + n + '"]');
          if (!list) return;

          list.innerHTML = '';
          const selected = getSelected(n);

          if (selected.length === 0) {
            const li = document.createElement('li');
            li.textContent = '—';
            li.style.opacity = '.6';
            list.appendChild(li);
            return;
          }

          selected.forEach((input) => {
            const li = document.createElement('li');
            li.textContent = input.dataset.title || 'Selected item';
            list.appendChild(li);
          });
        });
      }

      function setCardSelectedStates() {
        root.querySelectorAll('.bb-card').forEach(card => card.classList.remove('is-selected'));
        root.querySelectorAll('input[data-step-choice]').forEach(input => {
          const card = input.closest('.bb-card');
          if (card && input.checked) card.classList.add('is-selected');
        });
      }

      function clearErrors() {
        steps.forEach(stepEl => {
          const err = stepEl.querySelector('[data-error]');
          if (err) err.textContent = '';
        });
      }

      function validateAll(showErrors) {
        clearErrors();
        statusEl.textContent = '';

        let ok = true;
        let msgParts = [];

        [1,2,3].forEach((n) => {
          const selectedCount = getSelected(n).length;
          const limit = getLimit(n);
          if (selectedCount !== limit) {
            ok = false;
            msgParts.push(`Step ${n}: choose ${limit}`);
            if (showErrors) {
              const stepEl = root.querySelector('.bb-step[data-step="' + n + '"]');
              const err = stepEl ? stepEl.querySelector('[data-error]') : null;
              if (err) err.textContent = `Please select exactly ${limit} item(s) in Step ${n}.`;
            }
          }
        });

        if (addBtn) addBtn.disabled = !ok;
        if (hintEl) hintEl.textContent = ok ? 'All set! Click “Add Bundle to Cart”.' : ('Required: ' + msgParts.join(' • '));
        return ok;
      }

      function enforceLimit(stepNum, changedInput) {
        const limit = getLimit(stepNum);
        const selected = getSelected(stepNum);

        if (selected.length > limit) {
          changedInput.checked = false;
          statusEl.textContent = `You can only select ${limit} item(s) in Step ${stepNum}.`;
        }
      }

      function buildProperties() {
        propsHolder.innerHTML = '';

        function addProp(name, value) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = `properties[${name}]`;
          input.value = value;
          propsHolder.appendChild(input);
        }

        addProp('Bundle', 'Custom 3-Step Bundle');

        const s1 = getSelected(1);
        s1.forEach((i, idx) => addProp(`Step 1 - Choice ${idx + 1}`, i.dataset.title || ''));

        const s2 = getSelected(2);
        s2.forEach((i, idx) => addProp(`Step 2 - Choice ${idx + 1}`, i.dataset.title || ''));

        const s3 = getSelected(3);
        s3.forEach((i, idx) => addProp(`Step 3 - Choice ${idx + 1}`, i.dataset.title || ''));

        if ({{ section.settings.include_handles | json }}) {
          addProp('Step 1 Handles', s1.map(i => i.dataset.handle).join(', '));
          addProp('Step 2 Handles', s2.map(i => i.dataset.handle).join(', '));
          addProp('Step 3 Handles', s3.map(i => i.dataset.handle).join(', '));
        }
      }

      root.addEventListener('change', (e) => {
        const input = e.target;
        if (!input.matches('input[data-step-choice]')) return;

        const stepNum = Number(input.dataset.step);
        enforceLimit(stepNum, input);

        steps.forEach(setCounter);
        setCardSelectedStates();
        renderSummary();
        validateAll(false);
      });

      steps.forEach(setCounter);
      setCardSelectedStates();
      renderSummary();
      validateAll(false);

      addBtn.addEventListener('click', () => {
        const ok = validateAll(true);
        if (!ok) return;

        statusEl.textContent = 'Adding bundle to cart...';
        buildProperties();
        form.submit();
      });

    })();
  </script>
</section>

{% schema %}
{
  "name": "Bundle builder code NH",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Build your Combo"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Choose your items in each step. Price stays the same."
    },
    {
      "type": "product",
      "id": "bundle_product",
      "label": "Bundle product (required on Pages)",
      "info": "Select the $99 bundle product to add to cart."
    },
    {
      "type": "collection",
      "id": "step1_collection",
      "label": "Step 1 collection (9 products)"
    },
    {
      "type": "range",
      "id": "step1_limit",
      "min": 1,
      "max": 6,
      "step": 1,
      "label": "Step 1 required selections",
      "default": 2
    },
    {
      "type": "text",
      "id": "step1_note",
      "label": "Step 1 note",
      "default": "Select 2 items"
    },
    {
      "type": "collection",
      "id": "step2_collection",
      "label": "Step 2 collection (6 products)"
    },
    {
      "type": "range",
      "id": "step2_limit",
      "min": 1,
      "max": 6,
      "step": 1,
      "label": "Step 2 required selections",
      "default": 2
    },
    {
      "type": "text",
      "id": "step2_note",
      "label": "Step 2 note",
      "default": "Select 2 items"
    },
    {
      "type": "collection",
      "id": "step3_collection",
      "label": "Step 3 collection (6 products)"
    },
    {
      "type": "range",
      "id": "step3_limit",
      "min": 1,
      "max": 6,
      "step": 1,
      "label": "Step 3 required selections",
      "default": 1
    },
    {
      "type": "text",
      "id": "step3_note",
      "label": "Step 3 note",
      "default": "Select 1 item"
    },
    {
      "type": "checkbox",
      "id": "show_price",
      "label": "Show item prices in steps",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "include_handles",
      "label": "Include product handles in line item properties (debug)",
      "default": false
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "Button text",
      "default": "Add Bundle to Cart"
    }
  ],
  "presets": [
    {
      "name": "Bundle builder code by NH"
    }
  ]
}
{% endschema %}
